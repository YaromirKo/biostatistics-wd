---
title: "MPA WD vs Sp vs Control 2/3 (hand, machine)"
author: "Yaromir Kobikov <kobikov.yaromir@gmail.com>"
date: "Date: `r format(Sys.time(), '%d/%m/%Y')`"
output:
 word_document: default
 html_document:
  toc: true
  toc_float:
   collapsed: false
editor_options:
 chunk_output_type: inline
---

```{r setup, include=FALSE}
source("../BayesianPValue.R")
```

# MPA (Magnitude of Postural asymmetry)

Values in "+".

# Read Data

Read from Excel file.

```{r input}

rds_folder_name <- "../rds/task_3/"

file_name <- "../data/WD_PA 25 12 26_1.xlsx"
sheet <- "DATA_25 12 25"

my.seed <- 103592321 # reproducible Bayessian fit
threshold <- 1
myname0 <- "MPA"

data <- read_excel(file_name, sheet = sheet) %>%
  pivot_longer(
    cols = matches("^(Hand|MP)\\s*\\d+\\.\\d+$"),
    names_to = c("Measuerment method", "Measure", "Rep"),
    names_pattern = "^(Hand|MP)\\s*(\\d+)\\.(\\d+)$",
    values_to = "PA",
    values_drop_na = TRUE
  ) %>%
  rename(
    Measurement.1 = `Measurement 1`,
    Measurement.3 = `Measurement 3: 2-3H after treatment 2`
  ) %>%
  mutate(
    RatID   = factor(RatID),
    `Measuerment method`  = factor(`Measuerment method`, levels = c("Hand", "MP")),
    Measure = as.integer(Measure),
    Rep     = as.integer(Rep),
    MPA     = abs(PA),
    Trt = case_when(
      Measure == 1 ~ as.character(Measurement.1),  # WD
      Measure == 3 ~ as.character(Measurement.3),  # SSR / Conivaptan
      TRUE ~ NA_character_
    )
  ) %>%
  filter(
   Measure == 3 & Measurement.3 %in% c("Sp", "Control 2", "Control 3") | (Measure = 1 & Measurement.3 %in% c("Sp") & Trt == "24H WD")
  ) %>% 
  mutate(
    Trt = factor(Trt, levels = c("24H WD", "Sp", "Control 2", "Control 3"))
  ) %>%
  select(RatID, Trt, `Measuerment method`, Measure, PA, MPA) %>% 
  drop_na("PA") %>% 
  ungroup %>% droplevels(.)

data_hand <-
  data %>%
  filter(`Measuerment method` == "Hand") %>% 
  droplevels(.)

data_machine <-
  data %>%
  filter(`Measuerment method` == "MP") %>% 
  droplevels(.)

```

The group sizes are (distinct rats only, same rats with different stimulation locations are counted as duplicates)

```{r input2, echo=FALSE}

data %>% 
  arrange(Trt) %>% 
  group_by(Trt, `Measuerment method`) %>% 
  summarise(rats = length(unique(RatID)), .groups = "drop") %>%
  pivot_wider(names_from=c(Trt), values_from=rats) %>% 
  flextable %>% autofit

```

# (Hand) Analyse: 24 WD vs Sp vs Control 2/3
## MPA: Student Model

Prior predictive check

```{r mpa_check_prior}

data_hand_Trt <- 
  data_hand %>%
  droplevels(.)

myname <- paste0(myname0, "_wd_sp_control_2_3_mpa_Hand")

std.prior <- brm(
  data = data_hand_Trt,
  family = student,
  MPA ~ 0 + Trt + (1|RatID),
  prior = c(prior(student_t(3, 0, 10), class = "sigma"),
            prior(normal(0, 3), class = "b")),
  seed = my.seed, 
  chains = my.cores, 
  cores = my.cores, 
  iter = 4e4,
  sample_prior = "only",
  file = paste0(rds_folder_name, "wd_sp_2_3_mpa_check_prior_1.rds"),
  file_refit = "on_change"
)

cond_eff <- conditional_effects(std.prior,
                                "Trt",
                                method="fitted")

# cond_eff <- conditional_effects(std.prior, 
#                                 "Side", 
#                                 method="fitted", 
#                                 conditions=make_conditions(data_hand_Trt, vars = c("Time")))


plt[["WD&SpvsControl2,3 MPA prior vs data (hand)"]] <- plot(cond_eff, 
                                       points = TRUE, 
                                       point_args = list(width = 0.1, shape="o", col="red"),
                                       plot=FALSE)[[1]] + 
                                  geom_hline(yintercept=0, linetype="dashed", color="black")

set.seed(2)
plt[["WD&SpvsControl2,3 MPA prior pp_check (hand)"]] <- pp_check(std.prior, ndraws = 11)

print(cond_eff[[1]])
print(plt[["WD&SpvsControl2,3 MPA prior vs data (hand)"]])
print(plt[["WD&SpvsControl2,3 MPA prior pp_check (hand)"]])

```

Model fit and QC:

```{r mpa_model_summary, echo=FALSE, fig.width = 10}

std.fit <-  update(std.prior, 
                   sample_prior = "yes",
                   # control = list(adapt_delta = 0.99),
                   seed = my.seed, 
                   cores = my.cores,
                   file = paste0(rds_folder_name, "wd_sp_control_2_3_mpa_model_summary_1.rds"),
                   file_refit = "on_change")
summary(std.fit)

```

## MPA: MCMC conversion diagnostics

Posterior predictive check

```{r mpa_MCMC_ppcheck}

set.seed(2) # reproducible pp_check
plt[["WD&SpvsControl2,3 MPA pp_check (hand)"]] <- pp_check(std.fit, ndraws = 21)
print(plt[["WD&SpvsControl2,3 MPA pp_check (hand)"]])

```

Autocorrelations

```{r hand_mpa_MCMC_ac}

plt[["WD&SpvsControl2,3 MPA ac (hand)"]] <- stan_ac(std.fit$fit)
print(plt[["WD&SpvsControl2,3 MPA ac (hand)"]])

```

## MPA: Estimated model marginals

Estimated model medians +- 95% HPDCI (HPDCI = highest posterior density continuous interval) as a table:

```{r hand_mpa_emm}

emm <- emmeans(std.fit, ~ Trt, regrid = "response", nesting = NULL)
emm_show(emm)

```

Estimated model means as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r hand_mpa_emm_plot, echo=FALSE, fig.width = 8}

plt[["WD&SpvsControl2,3 MPA emm (hand)"]] <- emm %>% emm_inorder %>%
  ggplot(aes(y = fct_rev(interaction(Trt, sep=", ", drop=TRUE)), x = .value, fill = Trt)) %>%
  my.stat_eyeh() +
  geom_vline(xintercept=0, linetype="dashed", color="black") +
  # geom_vline(xintercept=threshold, linetype="dashed", color="black") +
  # geom_vline(xintercept=-threshold, linetype="dashed", color="black") +
  labs(title=myname, y="", x="MPA (mm) WD&SpvsControl2,3")

print(plt[["WD&SpvsControl2,3 MPA emm (hand)"]])

```

Estimated model means as a median +- 95% HPDCI ("x" - mean values of measurements for each rat)

```{r points_hand_mpa_emm_plot, echo=FALSE, fig.width=8}

plt[["WD&SpvsControl2,3 MPA emm (hand) with Data Points"]] <- 
  plt[["WD&SpvsControl2,3 MPA emm (hand)"]] +
    geom_point(
      pch = 4,
      position = position_nudge(y=0.15),
      data = {
        data_hand_Trt %>%
          group_by(RatID, Trt) %>%
          summarise(.value = mean(MPA), .groups = "drop")
      },
      aes(x=.value))

print(plt[["WD&SpvsControl2,3 MPA emm (hand) with Data Points"]])

```
## MPA: Contrasts

Contrasts BI vs SS as a table:

```{r hand_mpa_contrasts}

emmc <- rbind(contrast(emm, simple = "Trt", method = "pairwise"))
emm_show(emmc)

```

Contrasts BI vs SS as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r hand_mpa_plot, echo=FALSE, fig.width = 8}

plt[["WD&SpvsControl2,3 MPA (hand)"]] <- emmc %>% emm_inorder %>%
  ggplot(aes( y = fct_rev(interaction(contrast, sep=", ", drop=TRUE)), x=.value, fill=contrast)) %>%
  my.stat_eyeh() +
  geom_vline(xintercept=0, linetype="dashed", color="black") +
  labs(title=myname, y="", x="MPA in mm, contrast: WD vs Sp vs Control 2,3")

print(plt[["WD&SpvsControl2,3 MPA (hand)"]])
```

# (Machine) Analyse 24H WD vs Sp vs Control 2,3
## MPA: Student Model

Prior predictive check

```{r machine_mpa_check_prior}

data_machine_Trt <- 
  data_machine %>%
  droplevels(.)

myname <- paste0(myname0, "_wd_sp_control_2_3_mpa_MP")

std.prior <- brm(
  data = data_machine_Trt,
  family = student,
  MPA ~ 0 + Trt + (1|RatID),
  prior = c(prior(student_t(3, 0, 10), class = "sigma"),
            prior(normal(0, 3), class = "b")),
  seed = my.seed, 
  chains = my.cores, 
  cores = my.cores, 
  iter = 4e4,
  sample_prior = "only",
  file = paste0(rds_folder_name, "wd_sp_control_2_3_mpa_check_prior_machine.rds"),
  file_refit = "on_change"
)

cond_eff <- conditional_effects(std.prior, 
                                "Trt", 
                                method="fitted")

plt[["WD&SpvsControl2,3 MPA prior vs data (Machine)"]] <- plot(cond_eff, 
                                       points = TRUE, 
                                       point_args = list(width = 0.1, shape="o", col="red"),
                                       plot=FALSE)[[1]] + 
                                  geom_hline(yintercept=0, linetype="dashed", color="black")

set.seed(2)
plt[["WD&SpvsControl2,3 MPA prior pp_check (Machine)"]] <- pp_check(std.prior, ndraws = 11)

print(cond_eff[[1]])
print(plt[["WD&SpvsControl2,3 MPA prior vs data (Machine)"]])
print(plt[["WD&SpvsControl2,3 MPA prior pp_check (Machine)"]])

```

Model fit and QC:

```{r machine_mpa_model_summary, echo=FALSE, fig.width = 10}

std.fit <-  update(std.prior, 
                   sample_prior = "yes",
                   # control = list(adapt_delta=0.999),
                   seed = my.seed, 
                   cores = my.cores,
                   file = paste0(rds_folder_name, "wd_sp_2_3_mpa_model_summary_machine.rds"),
                   file_refit = "on_change")
summary(std.fit)

```

## MPA: MCMC conversion diagnostics

Posterior predictive check

```{r machine_mpa_MCMC_ppcheck}

set.seed(2) # reproducible pp_check

plt[["WD&SpvsControl2,3 MPA pp_check (Machine)"]] <- pp_check(std.fit, ndraws = 21)
print(plt[["WD&SpvsControl2,3 MPA pp_check (Machine)"]])

```

Autocorrelations

```{r machine_mpa_MCMC_ac}

plt[["WD&SpvsControl2,3 MPA ac (Machine)"]] <- stan_ac(std.fit$fit)
print(plt[["WD&SpvsControl2,3 MPA ac (Machine)"]])

```

## MPA: Estimated model marginals

Estimated model medians +- 95% HPDCI (HPDCI = highest posterior density continuous interval) as a table:

```{r machine_mpa_emm}

emm <- emmeans(std.fit, ~ Trt, regrid = "response", nesting = NULL)
emm_show(emm)

```

Estimated model means as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r machine_mpa_emm_plot, echo=FALSE, fig.width = 8}

plt[["WD&SpvsControl2,3 MPA emm (Machine)"]] <- emm %>% emm_inorder %>%
  ggplot(aes(y = fct_rev(interaction(Trt, sep=", ", drop=TRUE)), x = .value, fill = Trt)) %>%
  my.stat_eyeh() +
  geom_vline(xintercept=0, linetype="dashed", color="black") +
  # geom_vline(xintercept=threshold, linetype="dashed", color="black") +
  # geom_vline(xintercept=-threshold, linetype="dashed", color="black") +
  labs(title=myname, y="", x="MPA (mm)")

print(plt[["WD&SpvsControl2,3 MPA emm (Machine)"]])

```

Estimated model means as a median +- 95% HPDCI ("x" - mean values of measurements for each rat)

```{r points_machine_mpa_emm_plot, echo=FALSE, fig.width=8}

plt[["WD&SpvsControl2,3 MPA emm (Machine) with Data Points"]] <- 
  plt[["WD&SpvsControl2,3 MPA emm (Machine)"]] +
    geom_point(
      pch = 4,
      position = position_jitterdodge(jitter.width = 0.6, seed = 2),
      data = {
        data_machine_Trt %>%
          group_by(RatID, Trt) %>%
          summarise(.value = mean(MPA), .groups = "drop")
      },
      aes(x=.value, y = as.numeric(fct_rev(interaction(Trt, sep=", ", drop=TRUE)))+0.2))

print(plt[["WD&SpvsControl2,3 MPA emm (Machine) with Data Points"]])

```
## MPA: Contrasts

Contrasts BI vs SS as a table:

```{r machine_mpa_contrasts}

emmc <- rbind(contrast(emm, simple = "Trt", method = "pairwise"))
emm_show(emmc)

```

Contrasts BI vs SS as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r machine_mpa_plot, echo=FALSE, fig.width = 8}

plt[["WD&SpvsControl2,3 MPA (Machine)"]] <- emmc %>% emm_inorder %>%
  ggplot(aes( y = fct_rev(interaction(contrast, sep=", ", drop=TRUE)), x=.value, fill=contrast)) %>%
  my.stat_eyeh() +
  geom_vline(xintercept=0, linetype="dashed", color="black") +
  labs(title=myname, y="", x="MPA in mm, contrast: WD vs Sp vs Control 2,3")

print(plt[["WD&SpvsControl2,3 MPA (Machine)"]])
```

# Editable PowerPoint plots generated...

```{r pptx, message=TRUE, warning=TRUE, include=FALSE, results='hide'}

myname <- paste0(myname0, "_WD_Sp_Control_2_3_Hand_Machine")

doc <- read_pptx()

for(nm in names(plt)) {
  doc <- doc %>%
    add_slide(layout = "Title and Content", master = "Office Theme") %>%
    ph_with(value = rvg::dml(ggobj = plt[[nm]]),
          location = ph_location_type(type = "body"
                                      #, width=S_width, height=S_height
                                      ),
          bg = "transparent" ) %>%
    ph_with(value = nm,
          location = ph_location_type(type = "title") )
}
doc %>% print(target = paste0(myname,".pptx"))

```
---
title: "SF, LR AI CherryRat TG 8 groups: Bayesian regression of smoothed stretch forces"
author: "Yaromir Kobikov <kobikov.yaromir@gmail.com>"
date: "Date: `r format(Sys.time(), '%d/%m/%Y')`"
output:
  word_document: default
  html_document:
    toc: true
    toc_float:
      collapsed: false
editor_options: 
  chunk_output_type: inline
---

```{r setup, include=FALSE}

source("../../BayesianPValue.R")

```

 # Read SF data 

# Contra vs ipsi

> **Stretch‑force experiments with symmetric CherryRat groups**  
> Force–distance curves from both hind limbs were recorded simultaneously after bilateral peptide injection.  
> Mechanical work for each limb (WL, WR) was obtained by integrating a loess‑smoothed force curve (span = 0.4, family = "symmetric") over 0–10 mm stretch.  
> Asymmetry was quantified as the work difference ΔW = WL − WR and the log‑ratio AI<sub>L/R</sub> = log₂(WL / WR).  

```{r input}

my.seed <- 20231103 # reproducible Bayessian fit
my.span <- 0.4

rds_folder_name <- "../../rds/sf/sf_0-2_LR_AI/"
# rds_folder_name <- "../../rds/sf/sf_0-2_CI_AI/"

dir.create(file.path(rds_folder_name), showWarnings = FALSE)
load("../SF Sp 0-1 0.4-1 1-2 0-2 0.4-2 loess(symmetric span0.1)_rats.RData")
rm(sf) # conserve memory, we do not need the raw data


dta <- sf_LR_AI %>%
# dta <- sf_CI_AI %>%
  filter(dT %in% c("T_0_2")) %>%
  rename(Time = Period) %>%
  droplevels(.)

```

The median (bars) and 95% HPDCI (whiskers) for SF AI data points. __NOT__ the uncertainties estimated by Bayesian model.

```{r plot_bars_hpdci_lr}

myname <- "SF 0-2 span=0.4 drug, time"

plt[["Groups, time"]] <- 
  dta %>% 
  group_by(Group, Time) %>% 
  median_hdci(AI, .width = 0.95) %>%
  ungroup() %>%
  ggplot(aes(x=interaction(Time, sep=", ", drop=TRUE), y=AI, fill=Group)) + 
    geom_bar(position=position_dodge(), stat="identity") +
    geom_errorbar(aes(ymin=.lower, ymax=.upper),
                  width=.2,   # Width of the error bars
                  position=position_dodge(.9)) +
    geom_hline(yintercept=0, linetype="dashed", color="black") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
    labs(title=myname, x="Medians and 95% HDCI", y="AI")

print(plt[["Groups, time"]])

```

# Analyse Groups, time

The group sizes are (distinct rats only, same rats with different stimulation locations are counted as duplicates)

```{r input2_pre, echo=FALSE}
dta_pre <- dta %>% 
  # filter(Time == '0min') %>% 
  droplevels(.)

d.sum <- dta_pre %>% 
  arrange(Group, Time) %>% 
  group_by(Group, Time) %>% 
  summarise(rats = length(unique(RatID)) ) %>%
  pivot_wider(names_from=c(Group), values_from=rats)

d.sum %>% flextable %>% fontsize(part = "header", size = 9) %>% autofit

```

## SF AI: Bayesian regression, student family

Prior predictive check


```{r sf_check_prior_pre}

std.prior <- brm(
  data = dta_pre,
  family = gaussian,
  AI ~ 0 + Time:Group + (1|RatID),
  # prior = c(
  #   prior(exponential(1),      class = "sd"),
  #   prior(student_t(3, 0, 2.5), class = "sigma"),
  #   prior(normal(0, 5),        class = "b")
  # ),
  
  prior = c(prior(normal(0, 3), class = "sigma"),
            prior(normal(0, 3), class = "sd"),
            prior(normal(0, 10), class = "b")),
  seed = my.seed, 
  chains = my.cores, 
  cores = my.cores, 
  iter = 4e4,
  sample_prior = "only",
  file = paste0(rds_folder_name, "_check_prior.rds"),
  file_refit = "on_change"
)


cond_eff <- conditional_effects(std.prior,
                                  "Group",
                                  method="fitted",
                                  conditions=make_conditions(dta, vars = c("Time"))
                                )

plt[["SF Groups, time prior check"]] <- plot(cond_eff,
                                       points = TRUE,
                                       point_args = list(width = 0.1, shape="o", col="red"),
                                       plot=FALSE)[[1]] +
                                  geom_hline(yintercept=0, linetype="dashed", color="black")

set.seed(2)
plt[["SF Groups, time prior pp_check"]] <- pp_check(std.prior, ndraws = 11)

print(cond_eff[[1]])
print(plt[["SF Groups, time prior check"]])
print(plt[["SF Groups, time prior pp_check"]])

```

Model fit and QC:

```{r sf_model_summary_pre, echo=FALSE, fig.width = 10}

std.fit <-  update(std.prior, 
                   sample_prior = "yes",
                   # control = list(adapt_delta = 0.99),
                   # control = list(max_treedepth = 15),
                   seed = my.seed, 
                   cores = my.cores,
                   file = paste0(rds_folder_name, "model_summary.rds"),
                   file_refit = "on_change")
summary(std.fit)

print(plot(conditional_effects(std.fit), ask=FALSE, plot=FALSE))

```

## SF AI: MCMC conversion diagnostics

Posterior predictive check

```{r sf_MCMC_ppcheck_pre}

set.seed(2) # reproducible pp_check

plt[["SF Groups, time pp_check"]] <- pp_check(std.fit, ndraws = 21)
print(plt[["SF Groups, time pp_check"]])

```

Autocorrelations

```{r sf_MCMC_ac_pre}

plt[["SF Groups, time ac"]] <- stan_ac(std.fit$fit)
print(plt[["SF Groups, time ac"]])

```

## SF AI: Estimated model marginals

Estimated model medians +- 95% HPDCI (HPDCI = highest posterior density continuous interval) as a table:

```{r sf_emm_pre}

emm <- emmeans(std.fit, ~ Time|Group, regrid = "response", nesting=NULL)
emm_show(emm)

```

Estimated model means as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r sf_emm2_pre, echo=FALSE, fig.width = 8}

plt[["SF Groups, time emm"]] <- emm %>% emm_inorder %>%
  ggplot(aes(x = interaction(Group, Time, sep=", ", drop=TRUE), y = .value, fill = Group)) %>%
  my.stat_eye() +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="Estimated Marginal Medians and 95% HPDCI", y="AI")

```

```{r points_sf_emm2_pre, echo=FALSE, fig.width=8}

plt[["SF Groups, time emm with Data Points"]] <- 
  plt[["SF Groups, time emm"]] +
    geom_point(
      pch = 4,
      position = position_jitterdodge(jitter.width = 0.9, jitter.height = 0, dodge.width = 0.9, seed = 2),
      data = {
        dta_pre %>%
          group_by(RatID, Group, Time) %>%
          summarise(.value = mean(AI), .groups = "drop")
      },
      aes(y=.value))

print(plt[["SF Groups, time emm with Data Points"]])

```

The bar and whiskers plot:

```{r sf_bar_whiskers_pre, echo=FALSE}

plt[["SF Groups, time bar whiskers"]] <- emm %>% gather_emmeans_draws %>% 
  median_hdci(.width = 0.95) %>% 
  ungroup() %>%
  ggplot(aes(x = interaction(Group, Time, sep=", ", drop=TRUE), y = .value, fill = Group)) + 
    geom_bar(position=position_dodge(), aes(y=.value),stat="identity") +
    geom_errorbar(aes(ymin=.lower, ymax=.upper),
                  width=.2,   # Width of the error bars
                  position=position_dodge(.9)) +
    geom_hline(yintercept=0, linetype="dashed", color="black") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
    labs(title=myname, x="Medians and 95% HDCI", y="AI")

print(plt[["SF Groups, time bar whiskers"]])

```

The ccdinterval plot with same data as above bars and whiskers:

```{r sf_ccdfinterval_pre, echo=FALSE}

plt[["SF Groups, time ccdfinterval"]] <- emm %>% gather_emmeans_draws %>%
  ggplot(aes(x = interaction(Group, Time, sep=", ", drop=TRUE), y = .value, fill = Group)) +
  stat_ccdfinterval(point_interval = median_hdci, .width = 0.95,
             shape = 16, point_color = "black", interval_color = "black", 
             position="dodge", slab_color = NA) +
    scale_fill_brewer(palette = "Set2") + 
    scale_color_brewer(palette = "Dark2") +
    theme(axis.text.x = element_text(angle = 30, hjust = 1)) +
  # coord_cartesian(ylim = c(0, 15.5), expand=FALSE) +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="Estimated Marginal Medians and 95% HPDCI", y="AI")

```

```{r points_sf_ccdfinterval_pre, echo=FALSE, fig.width=8}

plt[["SF Groups, time ccdfinterval with Data Points"]] <- 
  plt[["SF Groups, time ccdfinterval"]] +
    geom_point(
      pch = 4,
      position = position_jitterdodge(jitter.width = 0.9, jitter.height = 0, dodge.width = 0.9, seed = 2),
      data = {
        dta_pre %>%
          group_by(RatID, Group, Time) %>%
          summarise(.value = mean(AI), .groups = "drop")
      },
      aes(y=.value))

print(plt[["SF Groups, time ccdfinterval with Data Points"]])

```

## SF AI: Contrasts M2 vs M3,4,5:

Contrasts as a table:

```{r sf_contrasts_pre}

emmc <- contrast(
  emm, 
  method = "trt.vs.ctrl", # Treatment vs control contrast
  ref = which(levels(emm)[[1]] == "M2.1h.post"), # Set M2 as the reference
  by = "Group" # Perform contrasts separately for each Group
)

emm_show(emmc)

```

Contrasts M2 vs M3/4/5 as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r sf_by_pre, echo=FALSE, fig.width = 8}

plt[["SF by time"]] <- emmc %>% emm_inorder %>% 
  ggplot(aes(x = interaction(contrast, Group, sep=", ", drop=TRUE), y = .value, fill = Group)) %>%
  my.stat_eye() +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="0-2 sec", y="AI, contrast: M2 vs M3/4/5")

print(plt[["SF by time"]])

```

## SF AI: Groups:

Contrasts as a table:

```{r sf_contrasts_pre_2}

emmc <- contrast(emm, simple = "Group", method = "pairwise")
emm_show(emmc)

```


```{r sf_selected_contrasts_2}
desired_contrasts <- c(
  "Group0 - Group1",
  "Group0 - Group3",
  "Group0 - Group5",
  "Group0 - Group6",
  "Group0 - Group7",
  "Group1 - Group2",
  "Group1 - Group3",
  "Group1 - Group4",
  "Group1 - Group5",
  "Group1 - Group6",
  "Group1 - Group7",
  "Group3 - Group7",
  "Group5 - Group6",
  "Group6 - Group7"
)
filtered_emmc <- subset(emmc, contrast %in% desired_contrasts)
emm_show(filtered_emmc)
```

Contrasts by Groups as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r sf_by_pre_2, echo=FALSE, fig.width = 8}

plt[["SF by Group"]] <- filtered_emmc %>% emm_inorder %>% 
  ggplot(aes(x = interaction(contrast, Time, sep=", ", drop=TRUE), y = .value, fill = contrast)) %>%
  my.stat_eye() +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="0-2 sec", y="AI, Groups")

print(plt[["SF by Group"]])

```

```{r sf_selected_contrasts_3}
desired_contrasts <- c(
  "Group0 - Group1",
  "Group0 - Group3",
  "Group0 - Group5",
  "Group0 - Group6",
  "Group0 - Group7"
)


filtered_emmc_g0 <- subset(emmc, contrast %in% desired_contrasts)
emm_show(filtered_emmc_g0)
```

Contrasts by Groups as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r sf_by_pre_3, echo=FALSE, fig.width = 8}

plt[["SF by Group 0"]] <- filtered_emmc_g0 %>% emm_inorder %>% 
  ggplot(aes(x = interaction(Time, contrast, sep=", ", drop=TRUE), y = .value, fill = contrast)) %>%
  my.stat_eye() +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="0-2 sec", y="AI, Groups")

print(plt[["SF by Group 0"]])

```

```{r sf_selected_contrasts_4}
desired_contrasts <- c(
  "Group1 - Group2",
  "Group1 - Group3",
  "Group1 - Group4",
  "Group1 - Group5",
  "Group1 - Group6",
  "Group1 - Group7"
)


filtered_emmc_g1 <- subset(emmc, contrast %in% desired_contrasts)
emm_show(filtered_emmc_g1)
```

Contrasts by Groups as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r sf_by_pre_4, echo=FALSE, fig.width = 8}

plt[["SF by Group 1"]] <- filtered_emmc_g1 %>% emm_inorder %>% 
  ggplot(aes(x = interaction(Time, contrast, sep=", ", drop=TRUE), y = .value, fill = contrast)) %>%
  my.stat_eye() +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="0-2 sec", y="AI, Groups")

print(plt[["SF by Group 1"]])

```


```{r sf_selected_contrasts_5}
desired_contrasts <- c(
  "Group5 - Group6"
)


filtered_emmc_g5 <- subset(emmc, contrast %in% desired_contrasts)
emm_show(filtered_emmc_g5)
```

Contrasts by Groups as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r sf_by_pre_5, echo=FALSE, fig.width = 8}

plt[["SF by Group 6"]] <- filtered_emmc_g5 %>% emm_inorder %>% 
  ggplot(aes(x = interaction(Time, contrast, sep=", ", drop=TRUE), y = .value, fill = Time)) %>%
  my.stat_eye() +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="0-2 sec", y="AI, Groups")

print(plt[["SF by Group 6"]])

```

```{r sf_selected_contrasts_6}
desired_contrasts <- c(
  "Group0 - Group7",
  "Group1 - Group7",
  "Group3 - Group7",
  "Group6 - Group7"
)

filtered_emmc_g1 <- subset(emmc, contrast %in% desired_contrasts)
emm_show(filtered_emmc_g1)
```

Contrasts by Groups as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r sf_by_pre_6, echo=FALSE, fig.width = 8}

plt[["SF by Group 7"]] <- filtered_emmc_g1 %>% emm_inorder %>% 
  ggplot(aes(x = interaction(Time, contrast, sep=", ", drop=TRUE), y = .value, fill = contrast)) %>%
  my.stat_eye() +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="0-2 sec", y="AI, Groups")

print(plt[["SF by Group 7"]])

```

```{r sf_selected_contrasts_7}
emmc <- contrast(emm, simple = "Group", method = "pairwise")

desired_contrasts <- c(
  "Group0 - Group1",
  "Group0 - Group6",
  "Group0 - Group7",
  "Group1 - Group6",
  "Group1 - Group7",
  "Group3 - Group6",
  "Group3 - Group7"
)


filtered_emmc <- subset(emmc, contrast %in% desired_contrasts) %>% 
    contrast(simple = "contrast", method = "pairwise")

desired_contrasts2 <- c(
  "(Group0 - Group1) - (Group0 - Group7)",
  "(Group1 - Group7) - (Group1 - Group6)",
  "(Group0 - Group6) - (Group0 - Group7)",
  "(Group3 - Group6) - (Group3 - Group7)"
)

filtered_emmc <- subset(filtered_emmc, contrast %in% desired_contrasts2)

emm_show(filtered_emmc)

```

Contrasts by Groups as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r sf_by_pre_7, echo=FALSE, fig.width = 8}

plt[["SF by Group contrast of contrasts"]] <- filtered_emmc %>% emm_inorder %>% 
  ggplot(aes(x = interaction(Time, contrast, sep=", ", drop=TRUE), y = .value, fill = contrast)) %>%
  my.stat_eye() +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="0-2 sec", y="AI, Groups")

print(plt[["SF by Group contrast of contrasts"]])

```
```{r sf_selected_contrasts_8}
emmc <- contrast(emm, simple = "Group", method = "revpairwise")

emm_show(emmc)
desired_contrasts <- c(
  "Group7 - Group0",
  "Group7 - Group1",
  "Group7 - Group3",
  "Group7 - Group6"
)


filtered_emmc_g1 <- subset(emmc, contrast %in% desired_contrasts)
emm_show(filtered_emmc_g1)

```

Contrasts by Groups as a median +- 95% HPDCI (HPDCI = highest posterior density continuous interval):

```{r sf_by_pre_8, echo=FALSE, fig.width = 8}

plt[["SF by Group 7 new"]] <- filtered_emmc_g1 %>% emm_inorder %>% 
  ggplot(aes(x = interaction(Time, contrast, sep=", ", drop=TRUE), y = .value, fill = contrast)) %>%
  my.stat_eye() +
  geom_hline(yintercept=0, linetype="dashed", color="black") +
  labs(title=myname, x="0-2 sec", y="AI, Groups")

print(plt[["SF by Group 7 new"]])

```

# Editable PowerPoint plots generated...

```{r pptx, message=TRUE, warning=TRUE, include=FALSE, results='hide'}

myname <- "SF span=0.4 0-2 CI AI CherryRat TG Groups"

doc <- read_pptx()

for(nm in names(plt)) {
  doc <- doc %>%
    add_slide(layout = "Title and Content", master = "Office Theme") %>%
    ph_with(value = rvg::dml(ggobj = plt[[nm]]),
          location = ph_location_type(type = "body"
                                      #, width=S_width, height=S_height
                                      ),
          bg = "transparent" ) %>%
    ph_with(value = nm,
          location = ph_location_type(type = "title") )
}
doc %>% print(target = paste0(myname,".pptx"))

```
